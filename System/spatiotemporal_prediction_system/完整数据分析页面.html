<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åˆ†æä¸å¯è§†åŒ– - æ—¶ç©ºé¢„æµ‹ç³»ç»Ÿ</title>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 2rem;
        }
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .logo { font-size: 3rem; margin-bottom: 1rem; }
        .title { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; color: #2d3748; }
        .subtitle { font-size: 1.3rem; color: #718096; }
        .container { max-width: 1800px; margin: 0 auto; }
        .nav-card { background: white; border-radius: 15px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .back-btn { display: inline-block; padding: 0.75rem 1.5rem; background: #4a5568; color: white; text-decoration: none; border-radius: 8px; font-weight: 600; transition: all 0.3s; }
        .back-btn:hover { background: #2d3748; transform: translateY(-2px); }
        
        .analysis-selector { background: white; border-radius: 15px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .section-title { font-size: 1.5rem; font-weight: 700; color: #2d3748; margin-bottom: 1.5rem; }
        .btn-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; }
        .analysis-btn { padding: 1rem; background: linear-gradient(135deg, #4a90e2 0%, #5a67d8 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; font-size: 1rem; }
        .analysis-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(74, 144, 226, 0.4); }
        .analysis-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: white; border-radius: 15px; padding: 1.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.15); text-align: center; }
        .stat-label { font-size: 0.9rem; color: #718096; margin-bottom: 0.5rem; }
        .stat-value { font-size: 2.5rem; font-weight: 700; color: #4a90e2; }
        
        .chart-card { background: white; border-radius: 15px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .chart-title { font-size: 1.5rem; font-weight: 700; color: #2d3748; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #e2e8f0; }
        .chart-container { min-height: 400px; width: 100%; }
        
        .data-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .data-table th, .data-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem; }
        .data-table th { background: #f7fafc; font-weight: 600; color: #4a5568; position: sticky; top: 0; }
        .data-table tr:hover { background: #f7fafc; }
        .table-wrapper { max-height: 500px; overflow-y: auto; }
        
        .loading { text-align: center; padding: 4rem; color: #718096; font-size: 1.2rem; }
        .error { background: #fed7d7; color: #c53030; padding: 1.5rem; border-radius: 8px; margin: 1rem 0; }
        .success { background: #d4edda; color: #155724; padding: 1rem; border-radius: 8px; margin: 1rem 0; }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">ğŸ“ˆ</div>
        <h1 class="title">æ•°æ®åˆ†æä¸å¯è§†åŒ–</h1>
        <p class="subtitle">åŸå§‹æ•°æ®å¤šç»´åº¦åˆ†æ - 10ä¸ªåŒºå¿ç—…è™«å®³æ•°é‡ + åŒ—äº¬å¸‚æ°”è±¡æ•°æ®</p>
    </div>
    
    <div class="container">
        <div class="nav-card">
            <a href="http://localhost:8003/" class="back-btn">â† è¿”å›ç³»ç»Ÿé¦–é¡µ</a>
        </div>
        
        <!-- åˆ†æç±»å‹é€‰æ‹©å™¨ -->
        <div class="analysis-selector">
            <h2 class="section-title">é€‰æ‹©åˆ†æç±»å‹</h2>
            <div class="btn-grid">
                <button class="analysis-btn active" onclick="showAnalysis('yearly')">ğŸ“… å¹´åº¦è¶‹åŠ¿</button>
                <button class="analysis-btn" onclick="showAnalysis('monthly')">ğŸ“Š æœˆåº¦åˆ†æ</button>
                <button class="analysis-btn" onclick="showAnalysis('regional')">ğŸ—ºï¸ åŒºåŸŸå¯¹æ¯”</button>
                <button class="analysis-btn" onclick="showAnalysis('heatmap')">ğŸ”¥ çƒ­åŠ›å›¾</button>
                <button class="analysis-btn" onclick="showAnalysis('seasonal')">ğŸŒ¸ å­£èŠ‚æ€§åˆ†æ</button>
                <button class="analysis-btn" onclick="showAnalysis('weather')">ğŸŒ¤ï¸ æ°”è±¡å…³è”</button>
                <button class="analysis-btn" onclick="showAnalysis('raw')">ğŸ“‹ åŸå§‹æ•°æ®</button>
            </div>
        </div>
        
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">æ€»è®°å½•æ•°</div>
                <div class="stat-value" id="statTotal">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æ—¶é—´è·¨åº¦</div>
                <div class="stat-value" id="statYears">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">åŒºå¿æ•°é‡</div>
                <div class="stat-value" id="statRegions">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æ°”è±¡æŒ‡æ ‡</div>
                <div class="stat-value" id="statWeather">7</div>
            </div>
        </div>
        
        <!-- å¹´åº¦è¶‹åŠ¿ -->
        <div id="yearlySection" class="chart-card">
            <h2 class="chart-title">ğŸ“… å¹´åº¦è¶‹åŠ¿åˆ†æ</h2>
            <div id="yearlyChart" class="chart-container"><div class="loading">â³ åŠ è½½ä¸­...</div></div>
        </div>
        
        <!-- æœˆåº¦åˆ†æ -->
        <div id="monthlySection" class="chart-card" style="display:none;">
            <h2 class="chart-title">ğŸ“Š æœˆåº¦åˆ†æ</h2>
            <div id="monthlyChart" class="chart-container"><div class="loading">â³ åŠ è½½ä¸­...</div></div>
        </div>
        
        <!-- åŒºåŸŸå¯¹æ¯” -->
        <div id="regionalSection" class="chart-card" style="display:none;">
            <h2 class="chart-title">ğŸ—ºï¸ åŒºåŸŸå¯¹æ¯”åˆ†æ</h2>
            <div id="regionalChart" class="chart-container"><div class="loading">â³ åŠ è½½ä¸­...</div></div>
        </div>
        
        <!-- çƒ­åŠ›å›¾ -->
        <div id="heatmapSection" class="chart-card" style="display:none;">
            <h2 class="chart-title">ğŸ”¥ æ—¶ç©ºçƒ­åŠ›å›¾</h2>
            <div id="heatmapChart" class="chart-container"><div class="loading">â³ åŠ è½½ä¸­...</div></div>
        </div>
        
        <!-- å­£èŠ‚æ€§åˆ†æ -->
        <div id="seasonalSection" class="chart-card" style="display:none;">
            <h2 class="chart-title">ğŸŒ¸ å­£èŠ‚æ€§ä¸å‘¨æœŸæ€§åˆ†æ</h2>
            <div id="seasonalChart" class="chart-container"><div class="loading">â³ åŠ è½½ä¸­...</div></div>
        </div>
        
        <!-- æ°”è±¡å…³è” -->
        <div id="weatherSection" class="chart-card" style="display:none;">
            <h2 class="chart-title">ğŸŒ¤ï¸ æ°”è±¡å› å­å…³è”åˆ†æ</h2>
            <div id="weatherChart" class="chart-container"><div class="loading">â³ åŠ è½½ä¸­...</div></div>
        </div>
        
        <!-- åŸå§‹æ•°æ® -->
        <div id="rawSection" class="chart-card" style="display:none;">
            <h2 class="chart-title">ğŸ“‹ åŸå§‹æ•°æ®</h2>
            <div class="table-wrapper">
                <div id="rawDataTable"></div>
            </div>
        </div>
    </div>
    
    <script>
        let yearlyData = [];
        let monthlyData = [];
        let regionalData = [];
        let rawData = null;
        
        // é¡µé¢åŠ è½½æ—¶
        window.onload = async function() {
            await loadAllData();
        };
        
        // åŠ è½½æ‰€æœ‰æ•°æ®
        async function loadAllData() {
            try {
                // åŠ è½½å¹´åº¦æ•°æ®
                const yearlyRes = await fetch('/api/yearly-stats');
                const yearlyJson = await yearlyRes.json();
                console.log('å¹´åº¦æ•°æ®:', yearlyJson);
                if (yearlyJson.status === 'success' && yearlyJson.data) {
                    yearlyData = yearlyJson.data;
                    updateYearlyChart();
                    updateStats();
                }
                
                // åŠ è½½æœˆåº¦æ•°æ®
                const monthlyRes = await fetch('/api/monthly-stats');
                const monthlyJson = await monthlyRes.json();
                console.log('æœˆåº¦æ•°æ®:', monthlyJson);
                if (monthlyJson.status === 'success' && monthlyJson.data) {
                    monthlyData = monthlyJson.data;
                    updateMonthlyChart();
                }
                
                // åŠ è½½åŒºåŸŸæ•°æ®
                const regionalRes = await fetch('/api/regional-stats');
                const regionalJson = await regionalRes.json();
                console.log('åŒºåŸŸæ•°æ®:', regionalJson);
                if (regionalJson.status === 'success' && regionalJson.data) {
                    regionalData = regionalJson.data;
                    updateRegionalChart();
                }
                
                // åŠ è½½åŸå§‹æ•°æ®
                const rawRes = await fetch('/api/raw-data');
                const rawJson = await rawRes.json();
                console.log('åŸå§‹æ•°æ®:', rawJson);
                if (rawJson.status === 'success') {
                    rawData = rawJson;
                    updateRawDataTable();
                    updateHeatmap();
                    updateSeasonalAnalysis();
                    updateWeatherCorrelation();
                }
                
            } catch (error) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
                alert('æ•°æ®åŠ è½½å¤±è´¥: ' + error.message);
            }
        }
        
        // åˆ‡æ¢åˆ†æç±»å‹
        function showAnalysis(type) {
            // éšè—æ‰€æœ‰section
            ['yearly', 'monthly', 'regional', 'heatmap', 'seasonal', 'weather', 'raw'].forEach(t => {
                document.getElementById(t + 'Section').style.display = 'none';
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„section
            document.getElementById(type + 'Section').style.display = 'block';
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.analysis-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
        function updateStats() {
            if (yearlyData.length > 0) {
                const years = yearlyData.map(d => d.year);
                document.getElementById('statTotal').textContent = yearlyData.reduce((sum, d) => sum + d.count, 0);
                document.getElementById('statYears').textContent = `${Math.min(...years)}-${Math.max(...years)}`;
            }
            if (regionalData.length > 0) {
                document.getElementById('statRegions').textContent = regionalData.length;
            }
        }
        
        // æ›´æ–°å¹´åº¦è¶‹åŠ¿å›¾
        function updateYearlyChart() {
            if (!yearlyData || yearlyData.length === 0) {
                document.getElementById('yearlyChart').innerHTML = '<div class="error">âŒ å¹´åº¦æ•°æ®ä¸ºç©º</div>';
                return;
            }
            
            const layout = {
                title: 'å„å¹´åº¦ç—…è™«å®³æ•°é‡è¶‹åŠ¿',
                xaxis: { title: 'å¹´ä»½' },
                yaxis: { title: 'å¹³å‡å€¼' },
                template: 'plotly_white',
                height: 400
            };
            
            const trace = {
                x: yearlyData.map(d => d.year),
                y: yearlyData.map(d => d.average),
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#4a90e2', width: 3 },
                marker: { size: 12, color: '#5a67d8' },
                name: 'å¹³å‡å€¼'
            };
            
            Plotly.newPlot('yearlyChart', [trace], layout, {responsive: true});
        }
        
        // æ›´æ–°æœˆåº¦åˆ†æå›¾
        function updateMonthlyChart() {
            if (!monthlyData || monthlyData.length === 0) {
                document.getElementById('monthlyChart').innerHTML = '<div class="error">âŒ æœˆåº¦æ•°æ®ä¸ºç©º</div>';
                return;
            }
            
            const layout = {
                title: 'æœˆåº¦ç—…è™«å®³æ•°é‡åˆ†å¸ƒ',
                xaxis: { title: 'å¹´-æœˆ' },
                yaxis: { title: 'å¹³å‡å€¼' },
                template: 'plotly_white',
                height: 400
            };
            
            const trace = {
                x: monthlyData.map(d => `${d.year}-${String(d.month).padStart(2, '0')}`),
                y: monthlyData.map(d => d.average),
                type: 'bar',
                marker: { color: '#5a67d8' },
                name: 'æœˆåº¦å¹³å‡å€¼'
            };
            
            Plotly.newPlot('monthlyChart', [trace], layout, {responsive: true});
        }
        
        // æ›´æ–°åŒºåŸŸå¯¹æ¯”å›¾
        function updateRegionalChart() {
            if (!regionalData || regionalData.length === 0) {
                document.getElementById('regionalChart').innerHTML = '<div class="error">âŒ åŒºåŸŸæ•°æ®ä¸ºç©º</div>';
                return;
            }
            
            const layout = {
                title: 'å„åŒºå¿ç—…è™«å®³æ•°é‡å¯¹æ¯”',
                xaxis: { title: 'åŒºå¿' },
                yaxis: { title: 'å¹³å‡å€¼' },
                template: 'plotly_white',
                height: 400
            };
            
            const trace = {
                x: regionalData.map(d => d.county),
                y: regionalData.map(d => d.average),
                type: 'bar',
                marker: { 
                    color: regionalData.map(d => d.average),
                    colorscale: 'Blues'
                },
                name: 'åŒºåŸŸå¹³å‡å€¼'
            };
            
            Plotly.newPlot('regionalChart', [trace], layout, {responsive: true});
        }
        
        // æ›´æ–°çƒ­åŠ›å›¾
        function updateHeatmap() {
            if (!rawData || !rawData.data || rawData.data.length === 0) {
                document.getElementById('heatmapChart').innerHTML = '<div class="error">âŒ æ•°æ®ä¸è¶³</div>';
                return;
            }
            
            // å‡†å¤‡çƒ­åŠ›å›¾æ•°æ®ï¼šX=æ—¥æœŸï¼ŒY=åŒºå¿ï¼ŒZ=ç—…è™«å®³æ•°é‡
            const nodeCols = rawData.headers.filter(h => h.startsWith('Node_'));
            const dates = rawData.data.map(d => d.Date).slice(0, 50); // å–å‰50å¤©
            const z = [];
            
            nodeCols.forEach(col => {
                const values = rawData.data.slice(0, 50).map(d => d[col] || 0);
                z.push(values);
            });
            
            const layout = {
                title: 'æ—¶ç©ºçƒ­åŠ›å›¾ - å„åŒºå¿ç—…è™«å®³æ•°é‡',
                xaxis: { title: 'æ—¥æœŸ' },
                yaxis: { title: 'åŒºå¿', ticktext: nodeCols.map(c => c.replace('Node_', '')), tickvals: nodeCols.map((c, i) => i) },
                template: 'plotly_white',
                height: 500
            };
            
            const trace = {
                z: z,
                x: dates,
                y: nodeCols.map(c => c.replace('Node_', '')),
                type: 'heatmap',
                colorscale: 'YlOrRd',
                colorbar: { title: 'æ•°é‡' }
            };
            
            Plotly.newPlot('heatmapChart', [trace], layout, {responsive: true});
        }
        
        // æ›´æ–°å­£èŠ‚æ€§åˆ†æ
        function updateSeasonalAnalysis() {
            if (!monthlyData || monthlyData.length === 0) {
                document.getElementById('seasonalChart').innerHTML = '<div class="error">âŒ æ•°æ®ä¸è¶³</div>';
                return;
            }
            
            // æŒ‰æœˆä»½èšåˆï¼ˆæ‰€æœ‰å¹´ä»½çš„1æœˆã€2æœˆ...ï¼‰
            const monthlyAvg = {};
            monthlyData.forEach(d => {
                if (!monthlyAvg[d.month]) {
                    monthlyAvg[d.month] = { sum: 0, count: 0 };
                }
                monthlyAvg[d.month].sum += d.average;
                monthlyAvg[d.month].count += 1;
            });
            
            const months = [];
            const avgValues = [];
            for (let m = 1; m <= 12; m++) {
                const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
                months.push(monthNames[m-1]);
                if (monthlyAvg[m]) {
                    avgValues.push(monthlyAvg[m].sum / monthlyAvg[m].count);
                } else {
                    avgValues.push(0);
                }
            }
            
            const layout = {
                title: 'å­£èŠ‚æ€§å‘¨æœŸåˆ†æ - å„æœˆå¹³å‡ç—…è™«å®³æ•°é‡',
                xaxis: { title: 'æœˆä»½' },
                yaxis: { title: 'å¹³å‡å€¼' },
                template: 'plotly_white',
                height: 400
            };
            
            const trace = {
                x: months,
                y: avgValues,
                type: 'scatter',
                mode: 'lines+markers',
                fill: 'tozeroy',
                line: { color: '#f5576c', width: 3 },
                marker: { size: 10, color: '#f093fb' },
                name: 'å­£èŠ‚æ€§è¶‹åŠ¿'
            };
            
            Plotly.newPlot('seasonalChart', [trace], layout, {responsive: true});
        }
        
        // æ›´æ–°æ°”è±¡å…³è”åˆ†æ
        function updateWeatherCorrelation() {
            if (!rawData || !rawData.data || rawData.data.length === 0) {
                document.getElementById('weatherChart').innerHTML = '<div class="error">âŒ æ•°æ®ä¸è¶³</div>';
                return;
            }
            
            // è®¡ç®—æ¸©åº¦ä¸ç—…è™«å®³çš„å…³ç³»
            const weatherCols = ['AT', 'MaxT', 'MinT', 'Precip'];
            const nodeCols = rawData.headers.filter(h => h.startsWith('Node_'));
            
            // é€‰æ‹©ç¬¬ä¸€ä¸ªåŒºå¿ä½œä¸ºç¤ºä¾‹
            if (nodeCols.length === 0) {
                document.getElementById('weatherChart').innerHTML = '<div class="error">âŒ æ— åŒºå¿æ•°æ®</div>';
                return;
            }
            
            const targetNode = nodeCols[0];
            const traces = [];
            
            weatherCols.forEach((weatherCol, idx) => {
                if (!rawData.headers.includes(weatherCol)) return;
                
                const x = [];
                const y = [];
                rawData.data.forEach(row => {
                    if (row[weatherCol] != null && row[targetNode] != null) {
                        x.push(parseFloat(row[weatherCol]));
                        y.push(parseFloat(row[targetNode]));
                    }
                });
                
                if (x.length > 0) {
                    traces.push({
                        x: x,
                        y: y,
                        mode: 'markers',
                        type: 'scatter',
                        name: weatherCol,
                        marker: { size: 6 }
                    });
                }
            });
            
            const layout = {
                title: `æ°”è±¡å› å­ä¸${targetNode.replace('Node_', '')}ç—…è™«å®³æ•°é‡å…³ç³»`,
                xaxis: { title: 'æ°”è±¡å› å­å€¼' },
                yaxis: { title: 'ç—…è™«å®³æ•°é‡' },
                template: 'plotly_white',
                height: 400,
                showlegend: true
            };
            
            Plotly.newPlot('weatherChart', traces, layout, {responsive: true});
        }
        
        // æ›´æ–°åŸå§‹æ•°æ®è¡¨æ ¼
        function updateRawDataTable() {
            if (!rawData || !rawData.data || rawData.data.length === 0) {
                document.getElementById('rawDataTable').innerHTML = '<div class="error">âŒ æ— æ•°æ®</div>';
                return;
            }
            
            let html = '<table class="data-table"><thead><tr>';
            rawData.headers.forEach(header => {
                html += `<th>${header}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            rawData.data.slice(0, 100).forEach(row => {
                html += '<tr>';
                rawData.headers.forEach(header => {
                    const value = row[header] != null ? row[header] : '';
                    const displayValue = typeof value === 'number' ? value.toFixed(2) : value;
                    html += `<td>${displayValue}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            html += `<p style="margin-top: 1rem; color: #718096; text-align: center;">æ˜¾ç¤ºå‰100æ¡æ•°æ®ï¼Œå…±${rawData.total_rows}æ¡è®°å½•</p>`;
            
            document.getElementById('rawDataTable').innerHTML = html;
        }
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(message) {
            const div = document.createElement('div');
            div.className = 'success';
            div.textContent = 'âœ… ' + message;
            document.querySelector('.container').insertBefore(div, document.querySelector('.stats-grid'));
            setTimeout(() => div.remove(), 3000);
        }
    </script>
</body>
</html>
